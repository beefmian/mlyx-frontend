$(function(){function e(){var e=LoginManager.getUrlParam("gid"),i=LoginManager.getUrlParam("sid");if(e){var r=$("#game_list").find(".rdo-game[value="+e+"]");0!=r.length&&(r.prop("checked",!0),$("#game_name").find(".text").text(r.data("text")))}e&&i&&(a(e,function(){var e=$("#server_list").find(".rdo-game[value="+i+"]");0!=e.length&&(e.prop("checked",!0),$("#server_name").find(".text").text(e.data("text")))}),t(e,i))}function a(e,a){$("#server_list").find("ul").html('<div class="tac"><img src="'+origin_assets+'/images/loading.gif" /></div>'),$.ajax({url:origin_game+"/gameinfo/server/openserverlist",data:{gid:e},dataType:"jsonp",jsonp:"function",success:function(e){if(1==e.status){for(var t="",i=0,r=e.data.length;r>i;i++)t+='<li><label class="lbl-rdo"><input class="rdo-game" type="radio" name="server" value="'+e.data[i].sid+'" data-text="'+e.data[i].sname+'">'+e.data[i].sname+"</label></li>";$("#server_list").find("ul").html(t),"function"==$.type(a)&&a()}}})}function t(e,a){var t=$("#role_list");t.html('<img src="'+origin_assets+'/images/loading.gif" /></div>'),$.ajax({url:origin_game+"/gameinfo/server/loadplayerroles",data:{gid:e,sid:a},dataType:"jsonp",jsonp:"function",success:function(e){if(10001==e.status){var a=e.data.roles,i="";if(0===a.length)i="暂无角色";else for(var r=0,n=a.length;n>r;r++)i+='<li class="'+(0==r?"active":"")+((r+1)%3===0?" nrm":"")+'" data-value="'+a[r].roleId+'">'+a[r].roleName+" ("+a[r].roleLevel+"级)</li>";t.html(i)}else 10003==e.status?t.html("暂无角色"):t.html("游戏服务器异常，请联系在线客服")}})}function i(){var e=$("#order_wrap"),a="";switch(l.order.iplatformType){case"ALIPAY":a="支付宝支付";break;case"WEICHAT":a="微信支付"}e.find(".order-mode").text(a),e.find(".order-no").text(l.order.vorderNo),e.find(".order-user").text(l.nickname),e.find(".order-game").text(l.gamename+" "+l.sname),e.find(".order-money").text(l.order.irmb/100+"元"),e.find(".order-ingot").text(l.order.igameCurrency),$("#pay_backdrop").show(),e.show()}function r(){$.ajax({url:origin_recharge+"/recharge/alipay/getOrderSubmitForm",data:{vOrderNo:l.order.vorderNo,surl:encodeURIComponent(url_pay+"/payend?orderno="+l.order.vorderNo),target:"_blank",autoSubmit:!1},dataType:"jsonp",jsonp:"function",success:function(e){20001==e.status&&($("#submit_form").html(e.data),i())}})}function n(e){$.ajax({url:origin_recharge+"/recharge/alipay/getOrderInfoStatus",data:{vOrderNo:e},dataType:"jsonp",jsonp:"function",success:function(a){20001==a.status&&(a.data>=1?($("#qrcode_wrap").hide(),$("#end_wrap").show()):setTimeout(function(){n(e)},2e3))}})}function o(){if(0!==s){var e=$("#amount_list").find(".active"),a=0;a=0!==e.length?parseFloat(e.data("value")):parseFloat($("#other_amount").val()),a?(d=a,$("#ingot").text(s*a)):d=0}}var s=0,d=100,l=null;LoginManager.isLogined(function(e){e?LoginManager.getUserInfo(function(e){$("#pay_wrap").find(".recharge-account").text(e.nickname)}):location.href=url_user+"/login?surl="+encodeURIComponent(location.href)}),e(),$("#subnav").on("click",".item",function(e){var a=$(this),t=$("#pay_wrap"),i=a.data("value"),r=a.data("text");$("#subnav").find(".item.active").removeClass("active"),a.addClass("active"),t.find(".pay-mode").text(r),t.find(".explain-list").removeClass("active"),t.find("."+i+"-list").addClass("active")}),$("#game_name").on("click",function(e){$("#game_list").removeClass("hide"),$("#server_list").addClass("hide")}),$("#server_name").on("click",function(e){var t=$("#game_list").find('[name="game"]:checked');0!==t.length&&(a(t.val()),$("#game_list").addClass("hide"),$("#server_list").removeClass("hide"))}),$("#game_list, #server_list").on("click",".close",function(e){$(this).parent().addClass("hide")}),$("#game_list").on("click",".rdo-game",function(e){var t=$(this);t.closest("ul").find(".active").removeClass("active"),t.closest("li").addClass("active"),$("#game_name").find(".text").text(t.data("text")),$("#game_list").addClass("hide"),$("#server_name").find(".text").text("游戏服务器"),$("#server_list").removeClass("hide"),$("#role_name").text(""),s=t.data("ratio"),$("#ratio").text(s),a(t.val()),o()}),$("#server_list").on("click",".rdo-game",function(e){var a=$(this);a.closest("ul").find(".active").removeClass("active"),a.closest("li").addClass("active"),$("#server_name").find(".text").text(a.data("text")),$("#server_list").addClass("hide"),t($("#game_list").find('[name="game"]:checked').val(),a.val())}),$("#role_list").on("click","li",function(e){$("#role_list").find(".active").removeClass("active"),$(this).addClass("active")}),$("#amount_list").on("click","li",function(e){var a=$(this);$("#amount_list").find(".active").removeClass("active"),$("#other_amount").val("").removeClass("active"),a.addClass("active"),o()}),$("#other_amount").on("focus",function(e){$("#amount_list").find(".active").removeClass("active"),$(this).addClass("active"),d=0}),$("#other_amount").on("change",function(e){var a=$(this),t=parseFloat(a.val());isNaN(t)&&(a.val(""),t=0),o()}),$("#btn_recharge").on("click",function(){var e=$(this),a=$("#subnav").find(".active").data("value"),t=$("#game_list").find('[name="game"]:checked').val(),n=$("#server_list").find('[name="server"]:checked').val(),o=$("#role_list").find(".active").data("value"),s=d,c=$("#error_msg");return a?t?n?o?0>=s?void c.text("请选择充值金额"):(c.text(""),e.text("充值中...").prop("disabled",!0),void $.ajax({url:origin_recharge+"/recharge/"+a+"/initOrder",data:{iGameId:t,iWorldId:n,vUserId:LoginManager.userInfo.uid,iPlayerId:o,iRmb:s,surl:url_user+"/"},dataType:"jsonp",jsonp:"function",success:function(e){20001==e.status?(l=e.data,"alipay"==a?r():"weichat"==a&&i()):alert("充值失败")},complete:function(){e.text("立即充值").prop("disabled",!1)}})):void c.text("请选择角色名称"):void c.text("请选择游戏服务器"):void c.text("请选择游戏"):void c.text("请选择充值方式")}),$("#order_wrap").on("click",".btn-orange",function(e){var a=$("#alipaysubmit"),t=$("#order_wrap"),i=$("#end_wrap");t.hide(),i.find(".btn-orange").attr("href","/payend?orderno="+l.order.vorderNo),0!=a.length?(a.submit(),i.show()):($("#qrcode").html('<img class="block" src="'+origin_misc+"/misc/util/qrcode?text="+encodeURIComponent(l.payURL)+'&width=400&height=400" />'),$("#qrcode_wrap").show(),n(l.order.vorderNo))}),$("#order_wrap").on("click",".btn-default",function(e){$("#submit_form").html(""),$("#pay_backdrop").hide(),$("#order_wrap").hide()}),$("#order_wrap").on("click",".close",function(e){$("#submit_form").html(""),$("#pay_backdrop").hide(),$("#order_wrap").hide()}),$("#end_wrap").on("click",".close",function(e){$("#pay_backdrop").hide(),$("#end_wrap").hide()}),$("#end_wrap").on("click",".btn-back",function(e){$("#pay_backdrop").hide(),$("#end_wrap").hide()}),$("#qrcode_wrap").on("click",".close",function(e){$("#qrcode_wrap").hide(),$("#end_wrap").show()})});